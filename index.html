<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Afterwork location service</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>

        <div class="failed" id="failed">
        </div>

    <div class="container">
        
        <div class="login" id="login">
            <div class="row">
                <label>Käyttäjänimi: </label>
                <input type="text" name="uname" id="uname">
            </div>
            <div class="row">
                <label>Pin:</label>
                <input type="password" name="pwd" id="pwd">
            </div>
            <div class="btn login" id="submit" onClick=login()>
                Kirjaudu
            </div> 
        </div>

        <div class="btn afterwork" id="afterwork" onClick=geo()>
            Olen afterworkilla
        </div>

        <div class="loader" id="loader"></div>

        <div class="list" id="list">
            <div class="row">
                <label>Paikka: </label>
                <input list="venues" name="venues" class="venues" />
                <datalist id="venues"></datalist>
            </div>
            <div class="btn save" id="save" onClick=save()>
                Kirjaa sijainti
            </div>
        </div>
        
    </div>
    
    <script>
        const afterworkWebservice = 'https://ym8nrjkifa.execute-api.eu-west-1.amazonaws.com/prod/'
        const header = new Headers();
        header.append('Content-Type', 'application/json')

        function login() {
            let uname = document.getElementById("uname").value
            let pwd = document.getElementById("pwd").value

            document.getElementById("login").setAttribute("style", "display:none");
            document.getElementById("loader").setAttribute("style", "display:inline-block");
            
            fetch(afterworkWebservice + 'login?uname=' + uname + '&pwd=' + pwd, {"headers": header})
                .then( (response) => {
                    if (response.status !== 200) {
                    }

                    // TODO 
                    response.json().then((data) => {
                        if (data.ApiKey) {
                            header.append('x-api-key', data.ApiKey);

                            document.getElementById("loader").setAttribute("style", "display:none");
                            document.getElementById("afterwork").setAttribute("style", "display:inline-block");
                            document.getElementById("failed").setAttribute("style", "display:none");

                        } else {
                            document.getElementById("loader").setAttribute("style", "display:none");
                            document.getElementById("login").setAttribute("style", "display:inline-block");
                            document.getElementById("failed").setAttribute("style", "display:block");
                            document.getElementById("failed").innerHTML = "Login failed"

                        }
                    })

                })
                .catch((err) => {
                    console.log('Login error: ', err);
                });
        }

        function geo() {
            if ("geolocation" in navigator) {
                console.log('Getting location');

                document.getElementById("afterwork").setAttribute("style", "display:none");
                document.getElementById("loader").setAttribute("style", "display:inline-block");

                navigator.geolocation.getCurrentPosition(function (location) {
                    console.log("Get Venues");
                    getVenues(location.coords);
                });

            } else {

                console.log("Can't locate you!");

            }
        }

        function getVenues(coords) {
            console.log(afterworkWebservice + 'venues?ll=' + coords.latitude + ',' + coords.longitude);
            fetch(afterworkWebservice + 'venues?ll=' + coords.latitude + ',' + coords.longitude, {"headers": header})
                .then( (response) => {
                    if (response.status !== 200) {
                        console.log('Looks like there was a problem. Status Code: ' +
                            response.status);
                        return;
                    }

                    response.json().then(function (data) {
                        showPossibilities(data);
                    });
                })
                .catch(function (err) {
                    console.log('Fetch error: ', err);
                })
        }

        function showPossibilities(venues) {
            venues.map((venue) => {
                let node = document.createElement("OPTION");
                node.setAttribute("value", venue.name);
                document.getElementById("venues").appendChild(node);
            });
            console.log(venues)
            document.getElementById("loader").setAttribute("style", "display:none");
            document.getElementById("list").setAttribute("style", "display:block");
        }

    </script>
</body>

</html>